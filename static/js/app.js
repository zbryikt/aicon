// Generated by LiveScript 1.2.0
var main;
angular.module('main', ['ui.select2']).config(function($httpProvider){
  return $httpProvider.defaults.headers.common["X-CSRFToken"] = $.cookie('csrftoken');
}).directive('tags', function($compile){
  return {
    restrict: 'E',
    replace: true,
    scope: {
      "model": '=ngModel',
      name: '@'
    },
    template: "<input type='hidden' class='tags'>",
    link: function(scope, element, attrs){
      $(element).select2({
        tokenSeparators: [",", " "],
        multiple: true,
        data: [],
        createSearchChoice: function(term, data){
          if (data.filter(function(it){
            return it.text.localeCompare(term) === 0;
          }).length === 0) {
            return {
              id: term,
              text: term
            };
          }
        }
      }).on('change', function(e){
        return scope.$apply(function(){
          return scope.model = $(element).select2('data');
        });
      });
      return scope.$watch('model', function(v){
        if (v) {
          return $(element).select2('data', v);
        }
      });
    }
  };
}).directive('license', function($compile){
  return {
    restrict: 'E',
    replace: true,
    scope: {
      "model": '=ngModel',
      name: '@'
    },
    template: "<input type='hidden'>",
    link: function(scope, element, attrs){
      element.select2({
        placeholder: "choose a license",
        minimumInputLength: 0,
        ajax: {
          url: '/license/',
          type: 'GET',
          dataType: 'json',
          quiteMillis: 100,
          data: function(term, page){
            return {
              q: term,
              page_limit: 10,
              page: page
            };
          },
          results: function(d, p){
            return {
              results: d.data,
              more: d.hasNext
            };
          }
        },
        initSelection: function(){},
        formatResult: function(it){
          return (it.fields && "<div>" + it.pk + ". " + (it.fields && it.fields['name']) + "</div>") || "";
        },
        formatSelection: function(it){
          return (it.fields && "<div>" + it.pk + ". " + it.fields['name'] + "</div>") || "";
        },
        formatNoMatches: function(){
          return '找不到這個項目';
        },
        formatSearching: function(){
          return '搜尋中';
        },
        formatInputTooShort: function(){
          return '請多打幾個字';
        },
        id: function(e){
          return e.fields && e.pk + "" || "";
        },
        escapeMarkup: function(it){
          return it;
        }
      }).on('change', function(e){
        return scope.$apply(function(){
          return scope.model = $(element).select2('data');
        });
      });
      return scope.$watch('model', function(v){
        if (v) {
          return $(element).select2('data', v);
        }
      });
    }
  };
}).directive('icon', function($compile){
  return {
    restrict: 'E',
    replace: true,
    scope: {
      "src": "@",
      "del": "&",
      "class": "@"
    },
    template: "<div class='svg-icon {{class}}'><div class='object'></div><div class='mask'></div>" + "<div class='delete' ng-click='$event.stopPropagation();del({e: $event})'>" + "<i class='glyphicon glyphicon-minus-sign'></i></div></div>",
    link: function(scope, element, attrs){
      if (!attrs.del) {
        element.find('.delete').remove();
      }
      return attrs.$observe('src', function(v){
        if (v) {
          return element.find('.object').replaceWith("<object class='object' type='image/svg+xml' data='/m/" + v + "'></object>");
        } else {
          return element.find('.object').replaceWith("<div class='object'>no data</div>");
        }
      });
    }
  };
});
main = function($scope, $http){
  var glyphFormHandler, glyphFormHandlerStep1, glyphFormHandlerStep2;
  $scope.glyphs = [];
  $scope.tag = {
    list: []
  };
  $scope.lic = {
    name: "",
    desc: "",
    url: "",
    pd: false,
    at: false,
    sa: false,
    nd: false,
    nc: false,
    file: null
  };
  $scope.glyph = {
    'new': {}
  };
  $scope.iconset = {
    list: [],
    cur: {},
    detail: true
  };
  $scope.iconset.cur = {
    icons: [],
    pk: -1,
    name: ""
  };
  $scope.searchKeyword = "";
  $scope.detail = {};
  $scope.mouse = {
    select: false
  };
  $scope.mouse.over = function(e, g){
    console.log("moving: " + g.name);
    if (this.select) {
      return g.added = !g.added;
    }
  };
  $scope.searchTimer = null;
  $scope.$watch('searchKeyword', function(){
    if ($scope.searchTimer) {
      clearTimeout($scope.searchTimer);
    }
    return $scope.searchTimer = setTimeout(function(){
      return $scope.search();
    }, 700);
  });
  $scope.detail.show = function(e, s){
    this.cur = s;
    console.log(s.tags, s.license);
    e.stopPropagation();
    return $('#glyph-detail').modal('show');
  };
  $scope.iconset.del = function(e, s){
    var this$ = this;
    return $http['delete']("/iconset/" + s.pk).success(function(d){
      var that;
      if (that = this$.list.indexOf(s) + 1) {
        return this$.list.splice(that - 1, 1);
      }
    });
  };
  $scope.iconset.cur.add = function(g){
    if (!this.icons.filter(function(it){
      return parseInt(it.pk) === parseInt(g.pk);
    }).length) {
      g.added = true;
      return this.icons.push(g);
    } else {
      this.icons.splice(this.icons.indexOf(g), 1);
      return g.added = false;
    }
  };
  $scope.iconset.cur.del = function(e, g){
    var that;
    if (that = this.icons.indexOf(g) + 1) {
      return this.icons.splice(that - 1, 1);
    }
  };
  $scope.search = function(){
    console.log("searching: ", $scope.searchKeyword);
    return $http.get('/glyph/', {
      params: {
        q: $scope.searchKeyword,
        page_limit: 100
      }
    }).success(function(d){
      console.log("load glyphs..");
      return $scope.glyphs = d.data;
    });
  };
  $scope.buildFont = function(){
    return $http.post('/build/', $scope.iconset.cur.icons.map(function(it){
      return it.pk;
    })).success(function(d){
      if (d && d.name) {
        console.log("redirect to /build/" + d.name);
        return window.location.href = "/build/" + d.name;
      } else {
        return console.log("build font failed.");
      }
    });
  };
  $scope.iconset.cur.save = function(){
    var ref$, ref1$;
    if (this.icons.length === 0) {
      return;
    }
    return $http.post('/iconset/', (ref$ = (ref1$ = {}, ref1$.pk = this.pk, ref1$.name = this.name, ref1$), ref$.icons = this.icons.map(function(it){
      return it.pk;
    }), ref$)).success(function(d){
      console.log("save iconset done");
      return $scope.iconset.load();
    });
  };
  $scope.iconset.cur.set = function(s){
    var ref$;
    return (ref$ = $scope.iconset.cur).icons = s.icons, ref$.pk = s.pk, ref$.name = s.name, s;
  };
  $scope.iconset.load = function(){
    return $http.get('/iconset/').success(function(d){
      return $scope.iconset.list = d;
    });
  };
  $scope.lic.load = function(){
    return $http.get('/license/').success(function(d){
      return $scope.lic.list = d.data;
    });
  };
  $scope.lic.add = function(){
    if (!$scope.lic.name) {
      return;
    }
    $('#lic-form-pxy').load(function(){
      return $('#lic-uploader').modal('hide');
    });
    return $('#lic-form').submit();
  };
  $scope.glyph['new'].setSvg = function(it){
    $scope.glyph['new'].svg = $(it).val();
    return $scope.$apply();
  };
  glyphFormHandler = null;
  glyphFormHandlerStep1 = function(){
    var pks, f;
    console.log("step1...");
    pks = JSON.parse($('#glyph-form-pxy').contents().find('body').html());
    console.log("pks: ", pks);
    f = document.getElementById('glyph-uploader-svg').files;
    if (f.length === 1) {
      $('#glyph-uploader').modal('hide');
      return $scope.search();
    }
    angular.element('#glyph-uploader').scope().$apply(function(){
      var i, x;
      return $scope.newFiles.data = (function(){
        var i$, ref$, len$, results$ = [];
        for (i$ = 0, len$ = (ref$ = f).length; i$ < len$; ++i$) {
          i = i$;
          x = ref$[i$];
          results$.push({
            id: pks[i],
            svg: "svg/" + x.name,
            name: $scope.glyph['new'].name,
            author: $scope.glyph['new'].author,
            author_url: $scope.glyph['new'].author_url,
            license: $scope.glyph['new'].license,
            tags: $scope.glyph['new'].tags
          });
        }
        return results$;
      }());
    });
    $("#glyph-uploader .multiple").show();
    return $("#glyph-uploader .single").hide();
  };
  glyphFormHandlerStep2 = function(it){
    var pks, ret, i$, ref$, len$;
    console.log("multi edit submiited");
    pks = JSON.parse($('#glyph-form-pxy').contents().find('body').html());
    console.log("saved pk: ", pks);
    if (pks.length === $scope.newFiles.data.length) {
      $('#glyph-uploader').modal('hide');
      return $scope.search();
    }
    console.log($scope.newFiles.data);
    ret = [];
    for (i$ = 0, len$ = (ref$ = $scope.newFiles.data).length; i$ < len$; ++i$) {
      it = ref$[i$];
      if (!in$(it.id, pks)) {
        ret.push(it);
      }
    }
    $scope.newFiles.data = ret;
    console.log($scope.newFiles.data);
    return $scope.$apply();
  };
  $scope.newFiles = {
    data: [],
    save: function(){
      console.log("todo");
      glyphFormHandler = glyphFormHandlerStep2;
      $('#glyph-form-pxy').load(function(){
        return glyphFormHandler();
      });
      return $('#glyph-form').submit();
    }
  };
  $scope.glyph.add = function(){
    console.log('adding...');
    if (!$scope.glyph['new'].name) {
      return;
    }
    if (!$('#glyph-uploader-svg').val()) {
      return;
    }
    glyphFormHandler = glyphFormHandlerStep1;
    $('#glyph-form-pxy').load(function(){
      return glyphFormHandler();
    });
    return $('#glyph-form').submit();
  };
  $scope.tag.load = function(){
    return $http.get('/tag/').success(function(d){
      return $scope.tag.list = d.data;
    });
  };
  $scope.glyphUpload = {};
  $scope.glyphUpload.show = function(){
    $('#glyph-uploader').modal('show');
    $("#glyph-uploader .single").show();
    return $("#glyph-uploader .multiple").hide();
  };
  $scope.lic.load();
  return $scope.iconset.load();
};
function in$(x, xs){
  var i = -1, l = xs.length >>> 0;
  while (++i < l) if (x === xs[i]) return true;
  return false;
}